<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>GTA JS EDITION</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; pointer-events: none; }
        #speed { position: absolute; bottom: 20px; right: 20px; color: #0f0; font-size: 30px; display: none; }
        #hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; display: none; text-shadow: 2px 2px 5px black; }
    </style>
</head>
<body>

    <div id="ui">
        <b>CONTROLES:</b><br>
        WALK: WASD<br>
        CAR: Chegue perto e aperte <b>F</b><br>
        DIRIGIR: WASD + Espaço (Freio)<br>
        SAIR: <b>F</b>
    </div>
    <div id="speed">0 KM/H</div>
    <div id="hint">APERTE [F] PARA ENTRAR</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CONFIGURAÇÃO DA CENA ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Céu azul
        scene.fog = new THREE.Fog(0x87ceeb, 20, 100);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(50, 100, 50);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // --- CHÃO E CIDADE ---
        const floorGeo = new THREE.PlaneGeometry(1000, 1000);
        const floorMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Criar prédios aleatórios
        for(let i = 0; i < 60; i++) {
            const h = Math.random() * 20 + 5;
            const bGeo = new THREE.BoxGeometry(5, h, 5);
            const bMat = new THREE.MeshPhongMaterial({ color: Math.random() * 0xffffff });
            const b = new THREE.Mesh(bGeo, bMat);
            b.position.set(Math.random() * 200 - 100, h/2, Math.random() * 200 - 100);
            // Evitar prédios no centro (onde player nasce)
            if(b.position.length() > 15) {
                b.castShadow = true;
                b.receiveShadow = true;
                scene.add(b);
            }
        }

        // --- PLAYER (PERSONAGEM) ---
        const playerGroup = new THREE.Group();
        const bodyGeo = new THREE.CapsuleGeometry(0.4, 1, 4, 8);
        const bodyMat = new THREE.MeshPhongMaterial({ color: 0xff0000 });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.position.y = 0.9;
        body.castShadow = true;
        playerGroup.add(body);
        scene.add(playerGroup);

        // --- CARRO ---
        const carGroup = new THREE.Group();
        const carBody = new THREE.Mesh(new THREE.BoxGeometry(2, 0.8, 4), new THREE.MeshPhongMaterial({ color: 0xffff00 }));
        carBody.position.y = 0.6;
        carBody.castShadow = true;
        carGroup.add(carBody);
        
        const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.6, 2), new THREE.MeshPhongMaterial({ color: 0x333333 }));
        cabin.position.y = 1.3;
        carGroup.add(cabin);

        carGroup.position.set(10, 0, 10);
        scene.add(carGroup);

        // --- LÓGICA DE ESTADO ---
        let isDriving = false;
        let carSpeed = 0;
        let carRotation = 0;
        const keys = {};
        window.addEventListener('keydown', (e) => { 
            keys[e.key.toLowerCase()] = true;
            if(e.key.toLowerCase() === 'f') toggleVehicle();
        });
        window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        function toggleVehicle() {
            const dist = playerGroup.position.distanceTo(carGroup.position);
            if (!isDriving && dist < 3) {
                isDriving = true;
                playerGroup.visible = false;
                document.getElementById('speed').style.display = 'block';
            } else if (isDriving) {
                isDriving = false;
                playerGroup.visible = true;
                playerGroup.position.copy(carGroup.position).add(new THREE.Vector3(3, 0, 0));
                document.getElementById('speed').style.display = 'none';
            }
        }

        // --- LOOP DE ANIMAÇÃO ---
        function animate() {
            requestAnimationFrame(animate);

            if (!isDriving) {
                // Movimento do Jogador
                if (keys['w']) playerGroup.translateZ(-0.15);
                if (keys['s']) playerGroup.translateZ(0.15);
                if (keys['a']) playerGroup.rotation.y += 0.05;
                if (keys['d']) playerGroup.rotation.y -= 0.05;

                // Câmera segue jogador
                camera.position.lerp(new THREE.Vector3(
                    playerGroup.position.x - Math.sin(playerGroup.rotation.y) * 10,
                    playerGroup.position.y + 5,
                    playerGroup.position.z - Math.cos(playerGroup.rotation.y) * 10
                ), 0.1);
                camera.lookAt(playerGroup.position);

                // Dica para entrar no carro
                const dist = playerGroup.position.distanceTo(carGroup.position);
                document.getElementById('hint').style.display = (dist < 3) ? 'block' : 'none';

            } else {
                // Movimento do Carro (Física arcade)
                if (keys['w']) carSpeed += 0.01;
                else if (keys['s']) carSpeed -= 0.01;
                else carSpeed *= 0.98; // Atrito

                if (keys[' ']) carSpeed *= 0.9; // Freio

                if (Math.abs(carSpeed) > 0.01) {
                    if (keys['a']) carRotation += 0.03 * (carSpeed > 0 ? 1 : -1);
                    if (keys['d']) carRotation -= 0.03 * (carSpeed > 0 ? 1 : -1);
                }

                carGroup.rotation.y = carRotation;
                carGroup.translateZ(carSpeed);
                
                document.getElementById('speed').innerText = Math.round(Math.abs(carSpeed * 200)) + " KM/H";

                // Câmera segue carro
                camera.position.lerp(new THREE.Vector3(
                    carGroup.position.x - Math.sin(carGroup.rotation.y) * 15,
                    carGroup.position.y + 7,
                    carGroup.position.z - Math.cos(carGroup.rotation.y) * 15
                ), 0.1);
                camera.lookAt(carGroup.position);
            }

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
